/*!
 * SmartRadar chart, based on Raphael.js
 *
 * Version: 0.0.1pre
 * Date: 2012-05-11 17:33:27
 */
(function(t,D){function q(a,b,c){this.paper=a;this.options=E({},{centerX:300,centerY:300,font:t._availableAttrs.font,textFill:"#000",defaultRadius:200,otherCategoryFill:"none",meshDefaultFill:"none",meshDefaultStroke:"#5D5E3E",meshDefaultStrokeWidth:1,valuePointDefaultRadius:5,valuePointDefaultFill:"#FFF",valuePointDefaultStroke:"#0000FF",valuePointDefaultStrokeWidth:3,valuePointClickHandler:null,armFill:"none",armStroke:"#5D5E3E",armStrokeWidth:1,pathFillOpacity:1,pathFill:"none",pathStroke:"#121D31",
pathStrokeWidth:2,valueNumberFormat:"@VALUE@",valueNumberPostion:"default",valueNumberFontSize:12,categoryLegendFontSize:12,labelFontSize:12,startAngle:270,drawLabels:true,drawValueNumbers:true,drawArms:true,drawMeshes:true,drawCategoryLegends:true,virtualMember:0,meshes:null,categories:null,members:[]},b);this._store={outerRadius:this.options.defaultRadius,OTHER_CATEGORY_NAME:"_OTHER_",unitCount:0,unitAngle:360,categoriesMap:{},elements:{}};this.init();this.draw(c)}var z=function(a){typeof console!==
"undefined"&&console.log(a)},u=function(a,b){return b?a===D:a==D};if(t){if(t.fn.smartRadar){z("SmartRadar already exist!");return}}else throw Error("SmartRadar based on RaphaelJS, but Raphael does not exist!");var A=Object.prototype.hasOwnProperty,F=function(a){if(!a||!t.is(a,"object")||a.nodeType||a==a.window)return false;try{if(a.constructor&&!A.call(a,"constructor"))if(!A.call(a.constructor.prototype,"isPrototypeOf"))return false}catch(b){return false}for(var c in a);return u(c,true)||A.call(a,
c)},E=function(){var a,b,c,e,d,h=arguments[0]||{},k=1,f=arguments.length,g=false;if(typeof h==="boolean"){g=h;h=arguments[1]||{};k=2}if(typeof h!=="object"&&!t.is(h,"function"))h={};if(f===k){h=this;--k}for(;k<f;k++)if((a=arguments[k])!=null)for(b in a){c=h[b];e=a[b];if(h!==e)if(g&&e&&(F(e)||(d=t.is(e,"array")))){if(d){d=false;c=c&&t.is(c,"array")?c:[]}else c=c&&F(c)?c:{};h[b]=E(g,c,e)}else u(e,true)||(h[b]=e)}return h},G=t.isBBoxIntersect;q.prototype.destroy=function(){this.clear();delete this.values;
delete this._store;delete this.options;delete this.paper};q.prototype.clear=function(){var a=this._store;this._clearValueElements();this._clearLabelElements();delete a.categoriesMap;delete a.elements};q.prototype._clearLabelElements=function(){var a=this._store.elements;if(a.labelSet){this._clearSet(a.labelSet);delete a.labelSet}};q.prototype._clearValueElements=function(){var a=this._store.elements;if(a.valuePath){a.valuePath.remove();delete a.valuePath}if(a.valueCircleSet){this._clearSet(a.valueCircleSet);
delete a.valueCircleSet}if(a.valueTextSet){this._clearSet(a.valueTextSet);delete a.valueTextSet}};q.prototype._clearSet=function(a){if(a){for(;a.items.length;)a.pop().remove();a.clear()}};q.prototype.getPosition=function(a,b,c,e){var d=this.options;b=t.rad(b);c=c==null?d.centerX:c;e=e==null?d.centerY:e;return{x:c+a*Math.cos(b),y:e+a*Math.sin(b)}};q.prototype.init=function(){this._initMeshes();this._initCategories();this._initMembers()};q.prototype._initMeshes=function(){var a=this.options,b=this._store,
c=a.defaultRadius=parseFloat(a.defaultRadius),e=a.meshes,d,h;if(e&&(h=e.length)>0){var k=0,f,g;for(f=0;f<h;f++){d=e[f];g=parseFloat(d.width);k+=d.width=t.is(g,"finite")?g:c/h;if(!t.is(d.valuePointRadius-0,"finite"))d.valuePointRadius=a.valuePointDefaultRadius;if(u(d.valuePointFill))d.valuePointFill=a.valuePointDefaultFill;if(u(d.valuePointStroke))d.valuePointStroke=a.valuePointDefaultStroke;if(!t.is(d.valuePointStrokeWidth-0,"finite"))d.valuePointStrokeWidth=a.valuePointDefaultStrokeWidth;if(u(d.meshFill))d.meshFill=
a.meshDefaultFill;if(u(d.meshStroke))d.meshStroke=a.meshDefaultStroke;if(!t.is(d.meshStrokeWidth-0,"finite"))d.meshStrokeWidth=a.meshDefaultStrokeWidth}b.outerRadius=k}else a.meshes=[{width:c,valuePointRadius:a.valuePointDefaultRadius,valuePointFill:a.valuePointDefaultFill,valuePointStroke:a.valuePointDefaultStroke,valuePointStrokeWidth:a.valuePointDefaultStrokeWidth,meshFill:a.meshDefaultFill,meshStroke:a.meshDefaultStroke,meshStrokeWidth:a.meshDefaultStrokeWidth}]};q.prototype._addOtherCategory=
function(){var a=this.options,b=this._store,c=a.categories,e={name:b.OTHER_CATEGORY_NAME,fill:a.otherCategoryFill,criticalValues:[0]};a=a.meshes.length;for(i=1;i<=a;i++)e.criticalValues.push(b.outerRadius/a*i);c.push(e);return e};q.prototype._initCategories=function(){var a=this.options,b=this._store,c=a.categories=a.categories||[],e,d,h,k,f,g=b.categoriesMap,j=a.meshes.length;c.length===0&&this._addOtherCategory();d=0;for(k=c.length;d<k;d++){e=c[d];f=e.name;if(!f||f in g){c.splice(d,1);--k;--d}else{if(u(e.fill))e.fill=
a.otherCategoryFill;if(u(e.criticalValues)||e.criticalValues.length!=j+1){e.criticalValues=[0];for(h=1;h<=j;h++)e.criticalValues.push(b.outerRadius/j*h)}g[f]={config:e,members:[]}}}};q.prototype._initMembers=function(){var a=this.options,b=this._store,c=a.categories,e=a.members=a.members||[],d=e.length,h,k,f,g=b.categoriesMap,j=a.meshes.length;h=0;for(k=e.length;h<k;h++){f=e[h];t.is(f,"object")||(f=e[h]={name:f});if(!f.category||!g[f.category]){f.category=b.OTHER_CATEGORY_NAME;if(!g[f.category]){var l=
this._addOtherCategory();g[f.category]={config:l,members:[]}}}if(u(f.criticalValues)||f.criticalValues.length!=j+1)f.criticalValues=g[f.category].config.criticalValues;g[f.category].members.push(f)}if(a.virtualMember&&(k=c.length)>1)d+=k;b.unitCount=d;b.unitAngle=360/d};q.prototype.draw=function(a){this._drawCategories();this._drawArms();this._drawMeshes();this._drawLabels();this.drawValues(a)};q.prototype._drawCategories=function(){var a=this,b=a.paper,c=a.options,e=a._store,d=function(p,n,s){var r=
[],v=0;n=n;var x=e.unitAngle,w;r.push("M");r.push(c.centerX);for(r.push(c.centerY);v++<s;){w=a.getPosition(p,n);r.push("L");r.push(w.x);r.push(w.y);n+=x}r.push("Z");return r.join(",")},h=c.categories,k=h.length,f;if(!(k<2)){f=c.virtualMember;var g=e.outerRadius,j,l=f?c.startAngle-e.unitAngle:c.startAngle,o=f?1:0,m=e.categoriesMap;for(f=0;f<k;f++){j=h[f].name;j=m[j].members.length;b.path(d(g,l,j+o+1)).attr({fill:h[f].fill,stroke:"none"});l+=e.unitAngle*(j+o)}a._drawCategoryLegends()}};q.prototype._drawCategoryLegends=
function(){var a=this.paper,b=this.options,c=b.categories,e=c.length,d;d=b.centerX;var h=c[0].name,k=d,f,g,j;if(!(!b.drawCategoryLegends||e<2)){f=this.getPosition(this._store.outerRadius,90).y;g=a.text(d,f,h).attr("font",b.font).attr({"text-anchor":"middle","font-size":b.categoryLegendFontSize,fill:b.textFill});j=g.getBBox();k=Math.max(k-(j.width+21+2)*e/2,7);f+=j.height+2;g.remove();if(b.drawLabels){g=a.text(d,f,h).attr("font",b.font).attr({"font-size":b.labelFontSize,fill:b.textFill});j=g.getBBox();
f+=j.height+2;g.remove()}if(b.drawValueNumbers){g=a.text(d,f,h).attr("font",b.font).attr({"font-size":b.valueNumberFontSize,fill:b.textFill});j=g.getBBox();f+=j.height+2;g.remove()}for(d=0;d<e;d++){g=a.rect(k,f,14,14);g.attr({fill:c[d].fill,stroke:"none"});j=g.getBBox();k=j.x2+2;g=j.y+j.height/2;g=a.text(k,g,c[d].name);g.attr("font",b.font).attr({"text-anchor":"start","font-size":b.categoryLegendFontSize,fill:b.textFill});j=g.getBBox();k=j.x2+21}}};q.prototype._drawArms=function(){var a=this,b=a.paper,
c=a.options,e=a._store;if(c.drawArms){var d=function(g,j){var l=c.centerX,o=c.centerY,m=a.getPosition(g,j,l,o);return["M",l,o,"L",m.x,m.y,"Z"].join(",")},h=0,k=e.unitCount,f=e.unitAngle;for(e=e.outerRadius;h<k;){b.path(d(e,c.startAngle+f*h)).attr({fill:c.armFill,stroke:c.armStroke,"stroke-width":c.armStrokeWidth});++h}}};q.prototype._drawMeshes=function(){var a=this,b=a.paper,c=a.options;if(c.drawMeshes){var e=function(j,l){for(var o=["M"],m=c.startAngle,p=m+360;m<p;){var n=a.getPosition(j,m);o.push(n.x);
o.push(n.y);o.push("L");m+=l}o.push("Z");return o.join(",")},d=c.meshes,h,k,f=0,g=a._store.unitAngle;k=0;for(h=d.length;k<h;k++){f+=d[k].width;b.path(e(f,g)).attr({fill:d[k].meshFill,stroke:d[k].meshStroke,"stroke-width":d[k].meshStrokeWidth})}}};q.prototype._drawLabels=function(){var a=this,b=a.paper,c=a.options,e=a._store;if(c.drawLabels){var d=function(x,w,H){var y=c.centerX,B=c.centerY,C=Math.round;w=a.getPosition(x,w,y,B);x=w.x;w=w.y;return{x:C(x)===y?x:x<y?x-10:x+10,y:C(w)===B?w:w<B?w-10:w+
10,attr:{"text-anchor":C(x)===y?"middle":x<y?"end":"start","font-size":c.labelFontSize,fill:c.textFill,title:H}}},h=e.categoriesMap,k=e.outerRadius,f=e.unitAngle,g=c.virtualMember,j=g?1:0;g=g?c.startAngle-f:c.startAngle;var l=c.categories,o,m,p,n,s,r,v=e.elements.labelSet=b.set();o=0;for(e=l.length;o<e;o++){m=h[l[o].name].members;g+=f*j;n=0;for(p=m.length;n<p;n++){s=m[n].name;r=d(k,g,s);s=b.text(r.x,r.y,s);s.attr("font",c.font).attr(r.attr);s.data("angle",g);v.push(s);g+=f}}}};q.prototype.drawValues=
function(a){var b=this,c=b.paper,e=b.options,d,h,k,f,g,j;j=b._store.elements;var l,o,m=e.valuePointClickHandler;o=t.is(m,"function");a=b._initValues(a);if(!a||!t.is(a.data,"array"))z("Parameter values is invalid!");else{b.values=a;b._clearValueElements();d=b._calcDataMap(a);k=b._calcPoints(d);f=b._calcValueLines(k);(j.valuePath=c.path(f.path)).attr(f.attr);f=b._calcValuePoints(k);l=j.valueCircleSet=c.set();h=0;for(d=f.length;h<d;h++){g=c.circle(f[h].x,f[h].y,f[h].r);g.attr(f[h].attr);g.data("point",
f[h].point);l.push(g)}o&&l.forEach(function(p){p.click(function(){var n=this.data("point");n=[a.data[n.dataRowIndex],n,this].concat([].slice.call(arguments,0));m.apply(b,n)})});if(f=b._calcValueNumbers(k)){o=j.valueTextSet=c.set();h=0;for(d=f.length;h<d;h++){j=c.text(f[h].x,f[h].y,f[h].text);j.attr("font",e.font).attr(f[h].attr);j.data("point",f[h].point);o.push(j)}}b._fixTextPosition()}};q.prototype._initValues=function(a){var b=this,c=function(e,d,h,k,f,g){if(t.is(d,"array")&&d.length>0){if(!t.is(d[0],
"array")){e=b.options;var j=d.length,l=e.members.length,o,m;for(m=o=0;o<j&&m<l;o++,m++)d[o]=[d[o],e.members[m].name]}return{valueColIndex:u(h)?0:h,memberColIndex:u(k)?1:k,categoryColIndex:u(f)?2:f,displayValueColIndex:u(g)?3:g,data:d}}return e};if(t.is(a,"array"))a=c(a,a);else if(t.is(a,"object"))a=c(a,a.data,a.valueColIndex,a.memberColIndex,a.categoryColIndex,a.displayValueColIndex);return a};q.prototype._calcDataMap=function(a){var b=this._store,c={},e=a.valueColIndex,d=a.memberColIndex,h=a.categoryColIndex,
k=a.displayValueColIndex,f=b.OTHER_CATEGORY_NAME;b=b.categoriesMap;a=a.data;var g=a.length,j,l,o;if(g<1||e>=g||d>=g){z("Values property data is empty or invalid!");return c}if(u(h)||h>=a[0].length){l=f;h=-1}if(u(k)||k>=a[0].length)k=e;j=0;for(g=a.length;j<g;j++){if(h!==-1){l=a[j][h];l in b||(l=f)}c[l]||(c[l]={});o=a[j][d];c[l][o]={dataRowIndex:j,value:a[j][e],displayValue:a[j][k]}}return c};q.prototype._calcWidth=function(a,b,c){var e=function(){var o=0,m,p=a.length;for(m=0;m<p;m++)o+=parseFloat(a[m]);
return{index:p-1,width:o}},d=function(o){var m=[],p=o.length,n;for(n=0;n<p;n++)m[n]=parseFloat(o[n]);return m};c=parseFloat(c);var h=d(a);b=d(b);d=h.length;var k=b.length,f=b[0]>b[k-1]?-1:1;if(f*(c-b[0])<=0)return{index:0,width:0};else if(f*(c-b[k-1])>=0)return e();else{var g=e=0,j,l;j=1;for(l=0;j<k&&l<d;j++,l++)if(f*(c-b[j])<0){g+=(c-b[j-1])/(b[j]-b[j-1])*h[l];break}else{g+=h[l];if(c===b[j])break;else++e}return{index:e,width:g}}};q.prototype._calcPoints=function(a){var b=this.options,c=this._store,
e=[],d=c.unitAngle,h=b.categories,k=b.meshes;c=c.categoriesMap;var f=b.virtualMember,g=f?1:0;b=f?b.startAngle-d:b.startAngle;var j,l,o,m,p,n=[],s,r,v;j=0;for(f=k.length;j<f;j++)n.push(k[j].width);j=0;for(f=h.length;j<f;j++){k=h[j].name;l=c[k].members;b+=d*g;m=0;for(o=l.length;m<o;m++){p=l[m].name;if(r=a[k]&&a[k][p]){s=l[m].criticalValues;s=this._calcWidth(n,s,r.value);v=this.getPosition(s.width,b);p={x:v.x,y:v.y,angle:b,member:p,category:k,meshIndex:s.index,dataRowIndex:r.dataRowIndex,displayValue:r.displayValue};
e.push(p)}b+=d}}return e};q.prototype._calcValueLines=function(a){var b=this.options,c=[],e,d,h;d=0;for(e=a.length;d<e;d++){h=a[d];c.push(d===0?"M":"L");c.push(h.x);c.push(h.y)}c.push("Z");a={fill:b.pathFill,stroke:b.pathStroke,"stroke-width":b.pathStrokeWidth,"stroke-linejoin":"round"};if(b.pathFillOpacity!==1)a["fill-opacity"]=b.pathFillOpacity;return{path:c.join(","),attr:a}};q.prototype._calcValuePoints=function(a){var b=this.options,c,e,d,h,k=[];e=0;for(c=a.length;e<c;e++){d=a[e];h=b.meshes[d.meshIndex];
k.push({x:d.x,y:d.y,r:h.valuePointRadius,attr:{fill:h.valuePointFill,stroke:h.valuePointStroke,"stroke-width":h.valuePointStrokeWidth,title:d.member+": "+d.displayValue},point:d})}return k};q.prototype._calcValueNumbers=function(a){var b=this.options,c=this._store.elements.labelSet,e=[],d,h="under_label"===b.valueNumberPostion,k=b.valueNumberFormat+"",f=/@VALUE@/g,g;if(b.drawValueNumbers){var j=function(p){var n=b.centerX,s=b.centerY,r=p.x,v=p.y;if(Math.round(r)===n)v+=10*Math.sin(t.rad(p.angle));
return{x:Math.round(r)===n?r+2:r<n?r-10:r+10,y:Math.round(v)===s?v-2:v<s?v-10:v+10,attr:{"text-anchor":Math.round(r)===n?"middle":r<n?"end":"start","font-size":b.valueNumberFontSize,fill:b.textFill}}},l=function(p){p=g[p.angle].getBBox();return{x:p.x+0.5*p.width,y:p.y+1.4*p.height,attr:{"text-anchor":"middle","font-size":b.valueNumberFontSize,fill:b.textFill}}};if(h){g={};c.forEach(function(p){var n=p.data("angle");g[n]=p})}c=0;for(d=a.length;c<d;c++){var o=a[c],m=h?l(o):j(o);e.push({x:m.x,y:m.y,
text:k.replace(f,a[c].displayValue),attr:m.attr,point:o})}return e}};q.prototype._fixTextPosition=function(){var a=this,b=a.options,c=a._store,e=c.elements;if(b.drawLabels&&b.drawValueNumbers){var d="under_label"===b.valueNumberPostion,h=[];b=function(g){var j=g.data("point");j&&"angle"in j&&g.data("angle",j.angle);h.push(g)};var k=function(g,j){return g.sort(function(l,o){var m=l.data("angle"),p=o.data("angle"),n=j==="V";m=a.getPosition(100,m);if(n&&l.data("point"))m.y+=0.0010;p=a.getPosition(100,
p);if(n&&o.data("point"))p.y+=0.0010;return n?m.y-p.y:m.x-p.x})},f=function(g,j){var l=j==="V",o=l?"y":"x",m,p,n,s;g=k(g,j);if(d&&l&&g.length>0){s=g[0].getBBox();n=g[0].data("angle");l=1;for(p=g.length;l<p;l++)if(g[l].data("angle")===n){m=g[l].getBBox();p=m.y-s.y;m=a.getPosition(c.outerRadius,n).y-10;g[l].attr("y",m);g[0].attr("y",m-p);break}}l=0;for(p=g.length;l<p-1;l++){s=g[l].getBBox();for(n=l+1;n<p;n++)for(m=g[n].getBBox();G(s,m);){m=g[n].attr(o);g[n].attr(o,m+1);m=g[n].getBBox()}}};e.labelSet.forEach(b);
e.valueTextSet.forEach(b);f(h,"V");f(h,"H")}};t.fn.smartRadar=function(a,b){return new q(this,a,b)}})(typeof Raphael==="undefined"?this.Raphael:Raphael);
