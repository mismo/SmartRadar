/*!
 * SmartRadar chart, based on Raphael.js
 *
 * Version: 0.0.1pre
 * Date: 2012-05-10 17:53:46
 */
(function(s,D){function q(a,b,c){this.paper=a;this.options=E({},{centerX:300,centerY:300,font:s._availableAttrs.font,textFill:"#000",defaultRadius:200,otherCategoryFill:"none",meshDefaultFill:"none",meshDefaultStroke:"#5D5E3E",meshDefaultStrokeWidth:1,valuePointDefaultRadius:5,valuePointDefaultFill:"#FFF",valuePointDefaultStroke:"#0000FF",valuePointDefaultStrokeWidth:3,valuePointClickHandler:null,armFill:"none",armStroke:"#5D5E3E",armStrokeWidth:1,pathFill:"none",pathStroke:"#121D31",pathStrokeWidth:2,
valueNumberFormat:"@VALUE@",valueNumberPostion:"default",valueNumberFontSize:12,categoryLegendFontSize:12,labelFontSize:12,startAngle:270,drawLabels:true,drawValueNumbers:true,drawArms:true,drawMeshes:true,drawCategoryLegends:true,virtualMember:0,meshes:null,categories:null,members:[]},b);this._store={outerRadius:this.options.defaultRadius,OTHER_CATEGORY_NAME:"_OTHER_",unitCount:0,unitAngle:360,categoriesMap:{},elements:{}};this.init();this.draw(c)}var z=function(a){typeof console!=="undefined"&&
console.log(a)},u=function(a,b){return b?a===D:a==D};if(s){if(s.fn.smartRadar){z("SmartRadar already exist!");return}}else throw Error("SmartRadar based on RaphaelJS, but Raphael does not exist!");var A=Object.prototype.hasOwnProperty,F=function(a){if(!a||!s.is(a,"object")||a.nodeType||a==a.window)return false;try{if(a.constructor&&!A.call(a,"constructor"))if(!A.call(a.constructor.prototype,"isPrototypeOf"))return false}catch(b){return false}for(var c in a);return u(c,true)||A.call(a,c)},E=function(){var a,
b,c,f,d,g=arguments[0]||{},h=1,e=arguments.length,k=false;if(typeof g==="boolean"){k=g;g=arguments[1]||{};h=2}if(typeof g!=="object"&&!s.is(g,"function"))g={};if(e===h){g=this;--h}for(;h<e;h++)if((a=arguments[h])!=null)for(b in a){c=g[b];f=a[b];if(g!==f)if(k&&f&&(F(f)||(d=s.is(f,"array")))){if(d){d=false;c=c&&s.is(c,"array")?c:[]}else c=c&&F(c)?c:{};g[b]=E(k,c,f)}else u(f,true)||(g[b]=f)}return g},G=s.isBBoxIntersect;q.prototype.destroy=function(){this.clear();delete this.values;delete this._store;
delete this.options;delete this.paper};q.prototype.clear=function(){var a=this._store;this._clearValueElements();this._clearLabelElements();delete a.categoriesMap;delete a.elements};q.prototype._clearLabelElements=function(){var a=this._store.elements;if(a.labelSet){this._clearSet(a.labelSet);delete a.labelSet}};q.prototype._clearValueElements=function(){var a=this._store.elements;if(a.valuePath){a.valuePath.remove();delete a.valuePath}if(a.valueCircleSet){this._clearSet(a.valueCircleSet);delete a.valueCircleSet}if(a.valueTextSet){this._clearSet(a.valueTextSet);
delete a.valueTextSet}};q.prototype._clearSet=function(a){if(a){for(;a.items.length;)a.pop().remove();a.clear()}};q.prototype.getPosition=function(a,b,c,f){var d=this.options;b=s.rad(b);c=c==null?d.centerX:c;f=f==null?d.centerY:f;return{x:c+a*Math.cos(b),y:f+a*Math.sin(b)}};q.prototype.init=function(){this._initMeshes();this._initCategories();this._initMembers()};q.prototype._initMeshes=function(){var a=this.options,b=this._store,c=a.defaultRadius=parseFloat(a.defaultRadius),f=a.meshes,d,g;if(f&&
(g=f.length)>0){var h=0,e,k;for(e=0;e<g;e++){d=f[e];k=parseFloat(d.width);h+=d.width=s.is(k,"finite")?k:c/g;if(!s.is(d.valuePointRadius-0,"finite"))d.valuePointRadius=a.valuePointDefaultRadius;if(u(d.valuePointFill))d.valuePointFill=a.valuePointDefaultFill;if(u(d.valuePointStroke))d.valuePointStroke=a.valuePointDefaultStroke;if(!s.is(d.valuePointStrokeWidth-0,"finite"))d.valuePointStrokeWidth=a.valuePointDefaultStrokeWidth;if(u(d.meshFill))d.meshFill=a.meshDefaultFill;if(u(d.meshStroke))d.meshStroke=
a.meshDefaultStroke;if(!s.is(d.meshStrokeWidth-0,"finite"))d.meshStrokeWidth=a.meshDefaultStrokeWidth}b.outerRadius=h}else a.meshes=[{width:c,valuePointRadius:a.valuePointDefaultRadius,valuePointFill:a.valuePointDefaultFill,valuePointStroke:a.valuePointDefaultStroke,valuePointStrokeWidth:a.valuePointDefaultStrokeWidth,meshFill:a.meshDefaultFill,meshStroke:a.meshDefaultStroke,meshStrokeWidth:a.meshDefaultStrokeWidth}]};q.prototype._addOtherCategory=function(){var a=this.options,b=this._store,c=a.categories,
f={name:b.OTHER_CATEGORY_NAME,fill:a.otherCategoryFill,criticalValues:[0]};a=a.meshes.length;for(i=1;i<=a;i++)f.criticalValues.push(b.outerRadius/a*i);c.push(f);return f};q.prototype._initCategories=function(){var a=this.options,b=this._store,c=a.categories=a.categories||[],f,d,g,h,e,k=b.categoriesMap,j=a.meshes.length;c.length===0&&this._addOtherCategory();d=0;for(h=c.length;d<h;d++){f=c[d];e=f.name;if(!e||e in k){c.splice(d,1);--h;--d}else{if(u(f.fill))f.fill=a.otherCategoryFill;if(u(f.criticalValues)||
f.criticalValues.length!=j+1){f.criticalValues=[0];for(g=1;g<=j;g++)f.criticalValues.push(b.outerRadius/j*g)}k[e]={config:f,members:[]}}}};q.prototype._initMembers=function(){var a=this.options,b=this._store,c=a.categories,f=a.members=a.members||[],d=f.length,g,h,e,k=b.categoriesMap,j=a.meshes.length;g=0;for(h=f.length;g<h;g++){e=f[g];s.is(e,"object")||(e=f[g]={name:e});if(!e.category||!k[e.category]){e.category=b.OTHER_CATEGORY_NAME;if(!k[e.category]){var m=this._addOtherCategory();k[e.category]=
{config:m,members:[]}}}if(u(e.criticalValues)||e.criticalValues.length!=j+1)e.criticalValues=k[e.category].config.criticalValues;k[e.category].members.push(e)}if(a.virtualMember&&(h=c.length)>1)d+=h;b.unitCount=d;b.unitAngle=360/d};q.prototype.draw=function(a){this._drawCategories();this._drawArms();this._drawMeshes();this._drawLabels();this.drawValues(a)};q.prototype._drawCategories=function(){var a=this,b=a.paper,c=a.options,f=a._store,d=function(o,p,t){var r=[],v=0;p=p;var x=f.unitAngle,w;r.push("M");
r.push(c.centerX);for(r.push(c.centerY);v++<t;){w=a.getPosition(o,p);r.push("L");r.push(w.x);r.push(w.y);p+=x}r.push("Z");return r.join(",")},g=c.categories,h=g.length,e;if(!(h<2)){e=c.virtualMember;var k=f.outerRadius,j,m=e?c.startAngle-f.unitAngle:c.startAngle,l=e?1:0,n=f.categoriesMap;for(e=0;e<h;e++){j=g[e].name;j=n[j].members.length;b.path(d(k,m,j+l+1)).attr({fill:g[e].fill,stroke:"none"});m+=f.unitAngle*(j+l)}a._drawCategoryLegends()}};q.prototype._drawCategoryLegends=function(){var a=this.paper,
b=this.options,c=b.categories,f=c.length,d;d=b.centerX;var g=c[0].name,h=d,e,k,j;if(!(!b.drawCategoryLegends||f<2)){e=this.getPosition(this._store.outerRadius,90).y;k=a.text(d,e,g).attr("font",b.font).attr({"text-anchor":"middle","font-size":b.categoryLegendFontSize,fill:b.textFill});j=k.getBBox();h=Math.max(h-(j.width+21+2)*f/2,7);e+=j.height+2;k.remove();if(b.drawLabels){k=a.text(d,e,g).attr("font",b.font).attr({"font-size":b.labelFontSize,fill:b.textFill});j=k.getBBox();e+=j.height+2;k.remove()}if(b.drawValueNumbers){k=
a.text(d,e,g).attr("font",b.font).attr({"font-size":b.valueNumberFontSize,fill:b.textFill});j=k.getBBox();e+=j.height+2;k.remove()}for(d=0;d<f;d++){k=a.rect(h,e,14,14);k.attr({fill:c[d].fill,stroke:"none"});j=k.getBBox();h=j.x2+2;k=j.y+j.height/2;k=a.text(h,k,c[d].name);k.attr("font",b.font).attr({"text-anchor":"start","font-size":b.categoryLegendFontSize,fill:b.textFill});j=k.getBBox();h=j.x2+21}}};q.prototype._drawArms=function(){var a=this,b=a.paper,c=a.options,f=a._store;if(c.drawArms){var d=
function(k,j){var m=c.centerX,l=c.centerY,n=a.getPosition(k,j,m,l);return["M",m,l,"L",n.x,n.y,"Z"].join(",")},g=0,h=f.unitCount,e=f.unitAngle;for(f=f.outerRadius;g<h;){b.path(d(f,c.startAngle+e*g)).attr({fill:c.armFill,stroke:c.armStroke,"stroke-width":c.armStrokeWidth});++g}}};q.prototype._drawMeshes=function(){var a=this,b=a.paper,c=a.options;if(c.drawMeshes){var f=function(j,m){for(var l=["M"],n=c.startAngle,o=n+360;n<o;){var p=a.getPosition(j,n);l.push(p.x);l.push(p.y);l.push("L");n+=m}l.push("Z");
return l.join(",")},d=c.meshes,g,h,e=0,k=a._store.unitAngle;h=0;for(g=d.length;h<g;h++){e+=d[h].width;b.path(f(e,k)).attr({fill:d[h].meshFill,stroke:d[h].meshStroke,"stroke-width":d[h].meshStrokeWidth})}}};q.prototype._drawLabels=function(){var a=this,b=a.paper,c=a.options,f=a._store;if(c.drawLabels){var d=function(x,w,H){var y=c.centerX,B=c.centerY,C=Math.round;w=a.getPosition(x,w,y,B);x=w.x;w=w.y;return{x:C(x)===y?x:x<y?x-10:x+10,y:C(w)===B?w:w<B?w-10:w+10,attr:{"text-anchor":C(x)===y?"middle":
x<y?"end":"start","font-size":c.labelFontSize,fill:c.textFill,title:H}}},g=f.categoriesMap,h=f.outerRadius,e=f.unitAngle,k=c.virtualMember,j=k?1:0;k=k?c.startAngle-e:c.startAngle;var m=c.categories,l,n,o,p,t,r,v=f.elements.labelSet=b.set();l=0;for(f=m.length;l<f;l++){n=g[m[l].name].members;k+=e*j;p=0;for(o=n.length;p<o;p++){t=n[p].name;r=d(h,k,t);t=b.text(r.x,r.y,t);t.attr("font",c.font).attr(r.attr);t.data("angle",k);v.push(t);k+=e}}}};q.prototype.drawValues=function(a){var b=this,c=b.paper,f=b.options,
d,g,h,e,k,j;j=b._store.elements;var m,l,n=f.valuePointClickHandler;l=s.is(n,"function");a=b._initValues(a);if(!a||!s.is(a.data,"array"))z("Parameter values is invalid!");else{b.values=a;b._clearValueElements();d=b._calcDataMap(a);h=b._calcPoints(d);e=b._calcValueLines(h);(j.valuePath=c.path(e.path)).attr(e.attr);e=b._calcValuePoints(h);m=j.valueCircleSet=c.set();g=0;for(d=e.length;g<d;g++){k=c.circle(e[g].x,e[g].y,e[g].r);k.attr(e[g].attr);k.data("point",e[g].point);m.push(k)}l&&m.forEach(function(o){o.click(function(){var p=
this.data("point");p=[a.data[p.dataRowIndex],p,this].concat([].slice.call(arguments,0));n.apply(b,p)})});if(e=b._calcValueNumbers(h)){l=j.valueTextSet=c.set();g=0;for(d=e.length;g<d;g++){j=c.text(e[g].x,e[g].y,e[g].text);j.attr("font",f.font).attr(e[g].attr);j.data("point",e[g].point);l.push(j)}}b._fixTextPosition()}};q.prototype._initValues=function(a){var b=this,c=function(f,d,g,h,e,k){if(s.is(d,"array")&&d.length>0){if(!s.is(d[0],"array")){f=b.options;var j=d.length,m=f.members.length,l,n;for(n=
l=0;l<j&&n<m;l++,n++)d[l]=[d[l],f.members[n].name]}return{valueColIndex:u(g)?0:g,memberColIndex:u(h)?1:h,categoryColIndex:u(e)?2:e,displayValueColIndex:u(k)?3:k,data:d}}return f};if(s.is(a,"array"))a=c(a,a);else if(s.is(a,"object"))a=c(a,a.data,a.valueColIndex,a.memberColIndex,a.categoryColIndex,a.displayValueColIndex);return a};q.prototype._calcDataMap=function(a){var b=this._store,c={},f=a.valueColIndex,d=a.memberColIndex,g=a.categoryColIndex,h=a.displayValueColIndex,e=b.OTHER_CATEGORY_NAME;b=b.categoriesMap;
a=a.data;var k=a.length,j,m,l;if(k<1||f>=k||d>=k){z("Values property data is empty or invalid!");return c}if(u(g)||g>=a[0].length){m=e;g=-1}if(u(h)||h>=a[0].length)h=f;j=0;for(k=a.length;j<k;j++){if(g!==-1){m=a[j][g];m in b||(m=e)}c[m]||(c[m]={});l=a[j][d];c[m][l]={dataRowIndex:j,value:a[j][f],displayValue:a[j][h]}}return c};q.prototype._calcWidth=function(a,b,c){var f=function(){var l=0,n,o=a.length;for(n=0;n<o;n++)l+=parseFloat(a[n]);return{index:o-1,width:l}},d=function(l){var n=[],o=l.length,
p;for(p=0;p<o;p++)n[p]=parseFloat(l[p]);return n};c=parseFloat(c);var g=d(a);b=d(b);d=g.length;var h=b.length,e=b[0]>b[h-1]?-1:1;if(e*(c-b[0])<=0)return{index:0,width:0};else if(e*(c-b[h-1])>=0)return f();else{var k=f=0,j,m;j=1;for(m=0;j<h&&m<d;j++,m++)if(e*(c-b[j])<0){k+=(c-b[j-1])/(b[j]-b[j-1])*g[m];break}else{k+=g[m];if(c===b[j])break;else++f}return{index:f,width:k}}};q.prototype._calcPoints=function(a){var b=this.options,c=this._store,f=[],d=c.unitAngle,g=b.categories,h=b.meshes;c=c.categoriesMap;
var e=b.virtualMember,k=e?1:0;b=e?b.startAngle-d:b.startAngle;var j,m,l,n,o,p=[],t,r,v;j=0;for(e=h.length;j<e;j++)p.push(h[j].width);j=0;for(e=g.length;j<e;j++){h=g[j].name;m=c[h].members;b+=d*k;n=0;for(l=m.length;n<l;n++){o=m[n].name;if(r=a[h]&&a[h][o]){t=m[n].criticalValues;t=this._calcWidth(p,t,r.value);v=this.getPosition(t.width,b);o={x:v.x,y:v.y,angle:b,member:o,category:h,meshIndex:t.index,dataRowIndex:r.dataRowIndex,displayValue:r.displayValue};f.push(o)}b+=d}}return f};q.prototype._calcValueLines=
function(a){var b=this.options,c=[],f,d,g;d=0;for(f=a.length;d<f;d++){g=a[d];c.push(d===0?"M":"L");c.push(g.x);c.push(g.y)}c.push("Z");return{path:c.join(","),attr:{fill:b.pathFill,stroke:b.pathStroke,"stroke-width":b.pathStrokeWidth,"stroke-linejoin":"round"}}};q.prototype._calcValuePoints=function(a){var b=this.options,c,f,d,g,h=[];f=0;for(c=a.length;f<c;f++){d=a[f];g=b.meshes[d.meshIndex];h.push({x:d.x,y:d.y,r:g.valuePointRadius,attr:{fill:g.valuePointFill,stroke:g.valuePointStroke,"stroke-width":g.valuePointStrokeWidth,
title:d.member+": "+d.displayValue},point:d})}return h};q.prototype._calcValueNumbers=function(a){var b=this.options,c=this._store.elements.labelSet,f=[],d,g="under_label"===b.valueNumberPostion,h=b.valueNumberFormat+"",e=/@VALUE@/g,k;if(b.drawValueNumbers){var j=function(o){var p=b.centerX,t=b.centerY,r=o.x,v=o.y;if(Math.round(r)===p)v+=10*Math.sin(s.rad(o.angle));return{x:Math.round(r)===p?r+2:r<p?r-10:r+10,y:Math.round(v)===t?v-2:v<t?v-10:v+10,attr:{"text-anchor":Math.round(r)===p?"middle":r<p?
"end":"start","font-size":b.valueNumberFontSize,fill:b.textFill}}},m=function(o){o=k[o.angle].getBBox();return{x:o.x+0.5*o.width,y:o.y+1.4*o.height,attr:{"text-anchor":"middle","font-size":b.valueNumberFontSize,fill:b.textFill}}};if(g){k={};c.forEach(function(o){var p=o.data("angle");k[p]=o})}c=0;for(d=a.length;c<d;c++){var l=a[c],n=g?m(l):j(l);f.push({x:n.x,y:n.y,text:h.replace(e,a[c].displayValue),attr:n.attr,point:l})}return f}};q.prototype._fixTextPosition=function(){var a=this,b=a.options,c=
a._store.elements;if(b.drawLabels&&b.drawValueNumbers){var f=[];b=function(h){var e=h.data("point");e&&"angle"in e&&h.data("angle",e.angle);f.push(h)};var d=function(h,e){return h.sort(function(k,j){var m=k.data("angle"),l=j.data("angle");m=a.getPosition(100,m);l=a.getPosition(100,l);return e==="V"?m.y-l.y:m.x-l.x})},g=function(h,e){var k=e==="V"?"y":"x",j,m,l,n,o;h=d(h,e);l=0;for(m=h.length;l<m-1;l++){o=h[l].getBBox();for(n=l+1;n<m;n++)for(j=h[n].getBBox();G(o,j);){j=h[n].attr(k);h[n].attr(k,j+1);
j=h[n].getBBox()}}};c.labelSet.forEach(b);c.valueTextSet.forEach(b);g(f,"V");g(f,"H")}};s.fn.smartRadar=function(a,b){return new q(this,a,b)}})(typeof Raphael==="undefined"?this.Raphael:Raphael);
